name: ChatbotViralWorkflow
description: Intelligent chatbot integration with viral annotation backend
version: 4.5.0  # Updated version for Phase 3 integration
execution_strategy: event_driven  # FIXED: Use event_driven for proper trigger-based execution
error_handling: continue
enable_monitoring: true
workflow_directory: nanobrain/library/workflows/chatbot_viral_integration
enable_progress_reporting: true
progress_batch_interval: 3.0
progress_collapsed_by_default: true
progress_show_technical_errors: true
progress_preserve_session_history: true
max_parallel_steps: 3
step_timeout: 120.0
retry_attempts: 2
retry_delay: 1.0
validate_graph: true
allow_cycles: false
require_connected_graph: true

# Data directory configuration - configurable path for data storage and caching
data_directory: "../../data"  # Base data directory - can be overridden by environment or config
cache_directory: "../../data/cache"  # Cache directory for temporary files
csv_file_path: "../../data/alphavirus_analysis/BVBRC_genome_alphavirus.csv"  # Path to genome CSV data

steps:
- step_id: query_classification
  name: Query Classification
  description: Classify user queries and extract virus species using LLM agent
  class: nanobrain.library.workflows.chatbot_viral_integration.steps.query_classification_step.QueryClassificationStep
  estimated_time: 2.0
  config_file: config/steps/query_classification.yml

- step_id: virus_name_resolution
  name: Virus Name Resolution
  description: Resolve virus species using LLM with cache-first approach
  class: nanobrain.library.workflows.chatbot_viral_integration.steps.virus_name_resolution_step.VirusNameResolutionStep
  estimated_time: 5.0
  config_file: config/steps/virus_name_resolution.yml

# REPLACED: Multiple individual steps with single workflow step
- step_id: viral_protein_analysis
  name: Viral Protein Analysis Workflow
  description: Complete viral protein analysis workflow as a step
  class: nanobrain.library.workflows.viral_protein_analysis.alphavirus_workflow.AlphavirusWorkflow
  estimated_time: 1800.0
  timeout: 1800.0
  config_file: ../viral_protein_analysis/config/AlphavirusWorkflow.yml

- step_id: conversational_response
  name: Conversational Response
  description: Generate intelligent conversational responses about viruses
  class: nanobrain.library.workflows.chatbot_viral_integration.steps.conversational_response_step.ConversationalResponseStep
  estimated_time: 5.0
  config_file: config/steps/conversational_response.yml

- step_id: response_formatting
  name: Response Formatting
  description: Format analysis results for chatbot response
  class: nanobrain.library.workflows.chatbot_viral_integration.steps.response_formatting_step.ResponseFormattingStep
  estimated_time: 5.0
  config_file: config/steps/response_formatting.yml

# UPDATED: Links with data unit specification for auto-trigger functionality
links:
- link_id: query_to_virus_resolution
  source: query_classification.extracted_query_data
  target: virus_name_resolution.query_input
  link_type: direct
  description: "Transfer query classification to virus resolution"
  condition:
    field: routing_decision
    operator: equals
    value: virus_name_resolution

- link_id: virus_resolution_to_viral_analysis
  source: virus_name_resolution.resolution_output
  target: viral_protein_analysis.virus_input
  link_type: direct
  description: "Transfer resolved virus to workflow input"

- link_id: viral_analysis_to_response
  source: viral_protein_analysis.analysis_results
  target: response_formatting.analysis_input
  link_type: direct
  description: "Transfer workflow output to formatting"

# Alternative routing for conversational responses
- link_id: query_to_conversational_response
  source: query_classification.extracted_query_data
  target: conversational_response.query_input
  link_type: direct
  description: "Transfer query classification to conversational response"
  condition:
    field: routing_decision
    operator: equals
    value: conversational_response

- link_id: conversational_response_to_formatting
  source: conversational_response.final_response
  target: response_formatting.conversational_input
  link_type: direct
  description: "Transfer conversational response to formatting"

# UPDATED: Data units with class field
data_units:
- name: user_query
  class: nanobrain.core.data_unit.DataUnitMemory
  description: "User input query"
  persistent: false
  
- name: extracted_query_data
  class: nanobrain.core.data_unit.DataUnitMemory
  description: "Extracted query classification data"
  persistent: false
  
- name: resolution_output
  class: nanobrain.core.data_unit.DataUnitMemory
  description: "Virus name resolution results"
  persistent: false
  
- name: analysis_results
  class: nanobrain.core.data_unit.DataUnitFile
  description: "Viral protein analysis workflow results"
  persistent: true
  file_path: "results/viral_protein_analysis.json"
  
- name: formatted_response
  class: nanobrain.core.data_unit.DataUnitMemory
  description: "Formatted chatbot response"
  persistent: false

# REMOVED: Step-level trigger definitions - handled by framework
# Steps define their own input_data_received triggers in their config files
# Links automatically create triggers and transfer data

# Execution configuration for event-driven workflow
execution:
  start_with: query_classification  # Event-driven execution starts when user_query data unit is set
  error_handling: continue
  parallel_execution: false
  timeout: 600.0

# Workflow metadata
workflow_metadata:
  framework_compliance: "from_config_mandatory"
  migration_status: "phase3_complete"
  integration_status: "workflow_as_step_enabled"
  execution_model: "event_driven_with_auto_trigger_links"  # FIXED: Indicate proper execution model
  last_updated: "2025-01-28"
  configuration_status: "production_ready"
  notes: "Uses AlphavirusWorkflow as step with proper event-driven execution and auto-trigger link-based data flow"
